from uplogic.nodes import ULActionNode
import pythonosc.udp_client

class ULOSCSend(ULActionNode):
    def __init__(self):
        ULActionNode.__init__(self)
      
        #Inputs
        self.condition = None
        self.ip = None
        self.port = None
        self.osc = None
        self.data = None
        
        #Outputs
        self.DONE = self.add_output(self._get_done)
        
        #Internal
        self._done = False
        self._client = None
        
    def _get_done(self):
        return self._done
    
    def evaluate(self):
        _condition = self.get_input(self.condition)
        _data = self.get_input(self.data)
        
        if self._client is None:
            _ip = self.get_input(self.ip)
            _port = self.get_input(self.port)
            
            self._setup_server(_ip, _port)
        
        self._done = False
        if _condition and _data:
            _osc = self.get_input(self.osc)
            self._done = self._send_osc(_osc, _data)   
            
            
    def _setup_server(self, ip, port): 
        try:
            self._client = pythonosc.udp_client.SimpleUDPClient(ip,port)
        except Exception as e:
            print(f"OSC Send Error: Could not create client - {e}")
            
    def _send_osc(self, osc, data):
        try:
            self._client.send_message(osc, [data])
            return True
        except Exception as e:
            print(f"OSC Send Error: {e}")
            return False